---
import { freshInstallStore } from '@/stores/backend';
import { preHealthCheck } from '@/utils/backend';
import InitWizard from '@/components/storykeep/widgets/InitWizard';

const isMultiTenant = import.meta.env.PUBLIC_ENABLE_MULTI_TENANT === 'true';

// Only run the "Wizard Check" logic if we are NOT in multi-tenant mode.
if (!isMultiTenant) {
  const tenantId =
    Astro.locals.tenant?.id || import.meta.env.PUBLIC_TENANTID || 'default';
  await preHealthCheck(tenantId);

  const { needsSetup } = freshInstallStore.get();
  if (!needsSetup) {
    return Astro.redirect('/storykeep');
  }
}

const isDev = import.meta.env.DEV;
const cssBasePath = '/styles';
const mainStylesUrl = isDev
  ? `${cssBasePath}/storykeep.css`
  : `${cssBasePath}/frontend.css`;
---

<!doctype html>
<html lang="en" class="h-full bg-gray-50">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Initialize TractStack</title>
    <link rel="stylesheet" href={`${cssBasePath}/custom.css`} />
    <link rel="stylesheet" href={mainStylesUrl} />
  </head>
  <body class="h-full">
    {
      isMultiTenant ? (
        <div class="flex min-h-screen items-center justify-center">
          <img src="/brand/logo.svg" class="h-16 w-auto" alt="Logo" />
        </div>
      ) : (
        <div class="max-w-5xl p-3.5 md:p-8">
          <InitWizard client:load />
        </div>
      )
    }

    <script>
      (function initCleanSlate() {
        try {
          document.cookie =
            'admin_auth=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax';
          document.cookie =
            'editor_auth=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax';
          document.cookie =
            'tractstack_session_id=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax';

          const tractStackKeys = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('tractstack_')) {
              tractStackKeys.push(key);
            }
          }
          tractStackKeys.forEach((key) => localStorage.removeItem(key));

          console.log('TractStack: Clean slate initialization complete');
        } catch (error) {
          console.warn('TractStack: Error during clean slate init:', error);
        }
      })();
    </script>
  </body>
</html>
