---
import Layout from '@/layouts/Layout.astro';
import StoryKeepDashboard from '@/components/storykeep/Dashboard';
import { requireAdminOrEditor, isAuthenticated, isAdmin } from '@/utils/auth';
import { getFullContentMap } from '@/stores/analytics';
import { getBrandConfig } from '@/stores/brand';

const adminCookie = Astro.cookies.get('admin_auth');
const editorCookie = Astro.cookies.get('editor_auth');
const authResult = isAuthenticated(Astro);
const adminResult = isAdmin(Astro);

const authCheck = requireAdminOrEditor(Astro);
if (authCheck) {
  return authCheck;
}

const goBackend = import.meta.env.PUBLIC_GO_BACKEND || 'http://localhost:8080';
const tenantId =
  Astro.locals.tenant?.id || import.meta.env.PUBLIC_TENANTID || 'default';

try {
  const statusResponse = await fetch(`${goBackend}/api/v1/health`, {
    headers: {
      'X-Tenant-ID': tenantId,
    },
    signal: AbortSignal.timeout(5000),
  });

  if (!statusResponse.ok) {
    const currentPath = Astro.url.pathname;
    return Astro.redirect(`/maint?from=${encodeURIComponent(currentPath)}`);
  }
} catch (error) {
  const currentPath = Astro.url.pathname;
  return Astro.redirect(`/maint?from=${encodeURIComponent(currentPath)}`);
}

const userIsAuthenticated = isAuthenticated(Astro);
const userIsAdmin = isAdmin(Astro);
const role = userIsAdmin ? `admin` : userIsAuthenticated ? `editor` : null;

const brandConfig = await getBrandConfig(
  Astro.locals.tenant?.id || import.meta.env.PUBLIC_TENANTID || 'default'
);
const initializing = !brandConfig.SITE_INIT;

const title = 'Dashboard | StoryKeep';

let fullContentMap;
let homeSlug = 'hello';

try {
  fullContentMap = await getFullContentMap(
    Astro.locals.tenant?.id || import.meta.env.PUBLIC_TENANTID || 'default'
  );
  homeSlug = fullContentMap.find((item) => item.isHome)?.slug || 'hello';
} catch (error) {
  const currentPath = Astro.url.pathname;
  return Astro.redirect(`/maint?from=${encodeURIComponent(currentPath)}`);
}

const urlPath = Astro.url.pathname + Astro.url.search;
const tabMatch = urlPath.match(/[?&]tab=([^&]+)/);
const tabParam = tabMatch ? tabMatch[1] : null;

const validTabs = ['analytics', 'content', 'branding', 'advanced'];
const initialTab =
  tabParam && validTabs.includes(tabParam) ? tabParam : 'analytics';
---

<Layout title={title} storykeep={true} slug="storykeep">
  <main id="main-content" class="min-h-screen w-full">
    <div class="p-8">
      <StoryKeepDashboard
        client:only="react"
        fullContentMap={fullContentMap}
        homeSlug={homeSlug}
        initialTab={initialTab}
        role={role}
        initializing={initializing}
      />
    </div>
  </main>
</Layout>
