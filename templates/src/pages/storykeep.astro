---
import Layout from '@/layouts/Layout.astro';
import StoryKeepDashboard from '@/components/storykeep/StoryKeepDashboard';
import { requireAdminOrEditor, isAuthenticated, isAdmin } from '@/utils/auth';
import { createStoryKeepMenu } from '@/utils/helpers';
import { getFullContentMap } from '@/stores/analytics';

// Check for privileged authentication - redirect if not authenticated
const authCheck = requireAdminOrEditor(Astro);
if (authCheck) return authCheck;

// Get authentication state
const userIsAuthenticated = isAuthenticated(Astro);
const userIsAdmin = isAdmin(Astro);

// Create the menu using the helper
const menu = createStoryKeepMenu({
  isAuthenticated: userIsAuthenticated,
  isAdmin: userIsAdmin,
});

const title = 'Dashboard | StoryKeep';

const fullContentMap = await getFullContentMap();
const homeSlug = fullContentMap.find((item) => item.isHome)?.slug || 'hello';

// Enhanced tab parameter handling for the new navigation system
const urlPath = Astro.url.pathname + Astro.url.search;
const tabMatch = urlPath.match(/[?&]tab=([^&]+)/);
const tabParam = tabMatch ? tabMatch[1] : null;

// Valid tabs from the actual project data
const validTabs = ['analytics', 'content', 'branding', 'advanced'];
// Determine initial tab with better fallback handling
const initialTab =
  tabParam && validTabs.includes(tabParam) ? tabParam : 'analytics';
---

<Layout title={title} storykeep={true} slug="storykeep" menu={menu}>
  <main id="main-content" class="min-h-screen w-full">
    <div class="p-8">
      <StoryKeepDashboard
        client:only="react"
        fullContentMap={fullContentMap}
        homeSlug={homeSlug}
        initialTab={initialTab}
      />
    </div>
  </main>
</Layout>
